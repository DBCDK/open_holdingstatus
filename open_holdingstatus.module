<?php

/**
 * Webservice @ http://guesstimate.dbc.dk/~fvs/OpenLibrary/OpenHoldingStatus/trunk/server.php
 * */


/**
 * Implements hook_ting_client_webservice (@see ting_client.module)
 * */
function open_holdingstatus_ting_client_webservice() {
  $ret = array();
  $ret['holdingstatus']['class'] = 'open_holdingstatus';
  $ret['holdingstatus']['url'] = 'open_holdingstatus_url';
  return $ret;
}

/**
 * do a localisation request
 * */
function open_holdingstatus_localisationRequest($pid, $agencyId = 'DK-870970', $mergePids = FALSE, $outputType = 'php') {

  $localisations = array();

  $client = new ting_client_class();
  $response = $client->do_holdingstatus(
    array(
      'action'         => 'localisationsRequest',
      'authentication' => FALSE,
      'agencyId'       => $agencyId,
      'pid'            => $pid,
      'mergePids'      => $mergePids,
      'outputType'     => $outputType,
      'callback'       => FALSE,
    )
  );

  $response = unserialize($response)->localisationsResponse->_value->localisations;

  if (isset($response->error)) {
    $error = $this->getValue($response->error);
    drupal_set_message(t($error, array(), array('context' => 'open_holdingstatus')), 'error');
  }
  else {
    foreach ($response as $localisation) {
      $pid = $localisation->_value->pid[0]->_value;
      $agencies = ( isset($localisation->_value->agency) ) ? $localisation->_value->agency : array();
      foreach ($agencies as $agency) {
        $localisations[$pid][] = array(
          'agencyId' => $agency->_value->agencyId->_value,
          'localIdentifier' => $agency->_value->localIdentifier->_value,
        );
      }
    }
  }

  return $localisations;
}


/**
 * Implements hook_form_FORM_ID_alter (ting_client_admin_webservices_settings)
 * add a field to webservice client settings
 * @url to borchk
 * */
function open_holdingstatus_form_ting_client_admin_webservices_settings_alter(&$form, &$form_state) {
  $form['ting']['open_holdingstatus_url'] = array(
    '#type' => 'textfield',
    '#title' => t('OpenHoldingStatus URL'),
    '#description' => t('URL to OpenHoldingStatus e.g.: http://openholdingstatus.addi.dk/1.0/ (or http://guesstimate.dbc.dk/~fvs/OpenLibrary/OpenHoldingStatus/trunk/server.php)'),
    '#required' => TRUE,
    '#default_value' => variable_get('open_holdingstatus_url', FALSE),
  );
}

/**
 * Implements hook_how_r_u()
 * @return Array
 */
function open_holdingstatus_how_r_u() {
  return array('Holdingstatus' => variable_get('open_holdingstatus_url'));
}
